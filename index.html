<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0f0e0c">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Italian Number Trainer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif&family=DM+Sans:opsz,wght@9..40,300..700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f0e0c;
      --fg: #e5e0d8;
      --fg-dim: #a39e94;
      --accent: #c8956c;
      --accent-soft: rgba(200,149,108,.12);
      --card: #171614;
      --card-border: #2a2722;
      --good: #8fd18f;
      --bad: #e8836a;
      --radius: 14px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-tap-highlight-color: transparent; }
    body {
      font-family: 'DM Sans', system-ui, sans-serif;
      background: var(--bg); color: var(--fg);
      min-height: 100dvh; padding: 1.5rem 1rem 2.5rem;
      text-align: center; overflow-x: hidden;
    }

    header { margin-bottom: 1.25rem; }
    h1 {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: 1.75rem; font-weight: 400;
      letter-spacing: .01em; margin-bottom: .2rem;
    }
    .hint { color: var(--fg-dim); font-size: .78rem; line-height: 1.4; }
    .hint b { color: var(--accent); font-weight: 500; }
    .hint-desktop { display: none; }
    @media(min-width:600px){ .hint-mobile{display:none} .hint-desktop{display:inline} }

    #number {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: clamp(1.6rem, 1.2rem + 2vw, 2.4rem);
      line-height: 1.3; margin: .5rem 0 .25rem;
      min-height: 2.5rem;
    }
    #userInput {
      font-family: 'JetBrains Mono', monospace;
      font-size: 1.1rem; padding: .45rem .6rem;
      text-align: center; border: 1px solid var(--card-border);
      border-radius: 10px; background: var(--card); color: var(--fg);
      outline: none; width: 180px; transition: border-color .15s;
    }
    #userInput:focus { border-color: var(--accent); }

    #answerBlock {
      min-height: 4.5rem; display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: .1rem; margin: .2rem 0;
    }
    #translation {
      font-family: 'Instrument Serif', Georgia, serif;
      font-size: clamp(1.15rem, .9rem + 1vw, 1.5rem);
      line-height: 1.35; color: var(--fg);
      opacity: 0; transform: translateY(4px);
      transition: opacity .25s ease, transform .25s ease;
    }
    #translation.show { opacity: 1; transform: translateY(0); }
    #timer {
      font-family: 'JetBrains Mono', monospace; font-size: .95rem;
      color: var(--fg-dim); transition: color .15s; margin-top: .1rem;
    }
    #timer.fast { color: var(--accent); }

    #tapBtn {
      display: flex; align-items: center; justify-content: center; gap: .45rem;
      width: 100%; max-width: 300px; margin: .75rem auto;
      padding: .8rem 1rem;
      font-family: 'DM Sans', sans-serif; font-size: .95rem; font-weight: 500;
      color: var(--bg); background: var(--accent); border: none; border-radius: 12px;
      cursor: pointer; -webkit-user-select: none; user-select: none;
      transition: transform .08s, opacity .08s;
    }
    #tapBtn:active { transform: scale(.97); opacity: .85; }
    #tapBtn svg { width: 16px; height: 16px; flex-shrink: 0; }

    #controls {
      display: flex; flex-wrap: wrap; gap: .35rem; justify-content: center;
      margin: .35rem auto .75rem; max-width: 440px;
    }
    .btn {
      font-family: 'DM Sans', sans-serif; font-size: .78rem; font-weight: 500;
      padding: .4rem .65rem; border-radius: 10px;
      border: 1px solid var(--card-border); background: var(--card);
      color: var(--fg-dim); cursor: pointer; transition: all .15s;
      -webkit-user-select: none; user-select: none;
    }
    .btn:active { transform: translateY(1px); }
    .btn.active { background: var(--accent-soft); color: var(--accent); border-color: rgba(200,149,108,.3); }
    .btn.ghost { border-color: transparent; background: transparent; }

    .divider { width: 40px; height: 1px; background: var(--card-border); margin: 1rem auto; }

    .stats-bar {
      display: flex; justify-content: center; gap: 1.25rem; flex-wrap: wrap;
      background: var(--card); border: 1px solid var(--card-border);
      border-radius: var(--radius); padding: .6rem 1rem;
      max-width: 440px; margin: 0 auto;
    }
    .stat-item { display: flex; flex-direction: column; align-items: center; gap: .05rem; }
    .stat-val { font-family: 'JetBrains Mono', monospace; font-size: .85rem; font-weight: 500; color: var(--fg); }
    .stat-label { font-size: .65rem; color: var(--fg-dim); text-transform: uppercase; letter-spacing: .06em; }

    .tip {
      color: var(--fg-dim); font-size: .75rem; max-width: 440px;
      margin: .75rem auto 0; line-height: 1.4;
    }
    .tip b { color: var(--accent); font-weight: 500; }
  </style>
</head>
<body>
  <header>
    <h1>Che numero è?</h1>
    <p class="hint">
      <span class="hint-mobile">Tap to reveal, tap again for next</span>
      <span class="hint-desktop"><b>Space</b> reveal / next · <b>Enter</b> advance</span>
    </p>
  </header>

  <div id="number">—</div>
  <input id="userInput" type="text" placeholder="Scrivi il numero..." style="display:none;" aria-label="Inserisci il numero in cifre">

  <div id="answerBlock">
    <div id="translation">—</div>
    <div id="timer">0.000 s</div>
  </div>

  <button id="tapBtn" onclick="handleTap()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
    <span id="tapLabel">Cominciamo</span>
  </button>

  <div id="controls">
    <button class="btn range-btn" id="btn100" onclick="setMax(100)">≤ 100</button>
    <button class="btn range-btn" id="btn1000" onclick="setMax(1000)">≤ 1.000</button>
    <button class="btn range-btn" id="btn10000" onclick="setMax(10000)">≤ 10.000</button>
    <button class="btn range-btn" id="btn100000" onclick="setMax(100000)">≤ 100.000</button>
    <button class="btn" id="reverseBtn" onclick="toggleReverse()">↔ Inverti</button>
    <button class="btn ghost" onclick="clearStats()">Azzera</button>
  </div>

  <div class="divider"></div>

  <div class="stats-bar">
    <div class="stat-item"><span class="stat-val" id="count">0</span><span class="stat-label">Trials</span></div>
    <div class="stat-item"><span class="stat-val" id="avg">—</span><span class="stat-label">Avg</span></div>
    <div class="stat-item"><span class="stat-val" id="best">—</span><span class="stat-label">Best</span></div>
    <div class="stat-item"><span class="stat-val" id="p95">—</span><span class="stat-label">P95</span></div>
  </div>

  <p class="tip">Toggle <b>↔ Inverti</b> to switch between Italian→digits and digits→Italian. In reverse mode, type your answer before revealing.</p>

<script>
/* ================================================================
   ITALIAN NUMBER TRAINER
   ================================================================ */

let reverseMode = false;
let currentNumber = null;
let maxRange = 100;
let startTime = null;
let running = false;
let revealed = false;

const numberEl = document.getElementById('number');
const timerEl = document.getElementById('timer');
const transEl = document.getElementById('translation');
const userInput = document.getElementById('userInput');
const tapLabel = document.getElementById('tapLabel');

setMax(100);

function toggleReverse() {
  reverseMode = !reverseMode;
  document.getElementById('reverseBtn').classList.toggle('active', reverseMode);
  userInput.style.display = reverseMode ? 'inline-block' : 'none';
  if (reverseMode) { userInput.value = ''; userInput.focus(); }
}

function setMax(val) {
  maxRange = val;
  document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('btn' + val);
  if (btn) btn.classList.add('active');
}

function numberToItalian(n) {
  if (n === 100000) return 'centomila';
  const ones = ['','uno','due','tre','quattro','cinque','sei','sette','otto','nove'];
  const teens = ['dieci','undici','dodici','tredici','quattordici','quindici','sedici','diciassette','diciotto','diciannove'];
  const tens = ['','','venti','trenta','quaranta','cinquanta','sessanta','settanta','ottanta','novanta'];
  const hundreds = ['','cento','duecento','trecento','quattrocento','cinquecento','seicento','settecento','ottocento','novecento'];

  function below1000(num) {
    if (num < 10) return ones[num];
    if (num < 20) return teens[num - 10];
    if (num < 100) {
      let ten = Math.floor(num / 10), unit = num % 10;
      let t = tens[ten];
      if (unit === 1 || unit === 8) t = t.slice(0, -1);
      return t + ones[unit];
    }
    if (num < 1000) {
      let cent = Math.floor(num / 100), rest = num % 100;
      let c = hundreds[cent];
      if (rest >= 80 && rest < 90 && c.endsWith('o')) c = c.slice(0, -1);
      return c + below1000(rest);
    }
    return '';
  }

  if (n < 1000) return below1000(n);
  const thousands = Math.floor(n / 1000);
  const rest = n % 1000;
  const prefix = thousands === 1 ? 'mille' : below1000(thousands) + 'mila';
  return prefix + below1000(rest);
}

function showNewNumber() {
  currentNumber = Math.floor(Math.random() * maxRange) + 1;
  revealed = false;
  transEl.classList.remove('show');
  transEl.style.color = '';

  transEl.textContent = reverseMode ? currentNumber.toLocaleString('it-IT') : numberToItalian(currentNumber);
  numberEl.textContent = reverseMode ? numberToItalian(currentNumber) : currentNumber.toLocaleString('it-IT');

  if (reverseMode) { userInput.style.display = 'inline-block'; userInput.value = ''; userInput.focus(); }
  else { userInput.style.display = 'none'; }

  timerEl.textContent = '0.000 s';
  timerEl.classList.remove('fast');
  startTime = performance.now();
  running = true;
  tapLabel.textContent = 'Rivela';
}

function revealAnswer() {
  const elapsed = (performance.now() - startTime) / 1000;
  timerEl.textContent = `${elapsed.toFixed(3)} s`;
  timerEl.classList.add('fast');

  if (reverseMode) {
    const guess = userInput.value.replace(/[.,\s]/g, '');
    const correct = guess === currentNumber.toString();
    transEl.style.color = correct ? 'var(--good)' : 'var(--bad)';
  }

  transEl.classList.add('show');
  revealed = true;
  recordTrial(elapsed);
  tapLabel.textContent = 'Avanti';
}

function handleTap() {
  if (!running) { showNewNumber(); return; }
  if (!revealed) revealAnswer(); else showNewNumber();
}

document.addEventListener('keydown', (e) => {
  if (e.code === 'Space') { e.preventDefault(); handleTap(); }
  else if (e.code === 'Enter' && revealed) showNewNumber();
});

/* ── Stats ── */
const times = [];
const avgEl = document.getElementById('avg');
const countEl = document.getElementById('count');
const bestEl = document.getElementById('best');
const p95El = document.getElementById('p95');

function recordTrial(s) {
  if (!isFinite(s) || s <= 0) return;
  times.push(s);
  updateStats();
}

function clearStats() {
  times.length = 0;
  updateStats();
}

function updateStats() {
  const n = times.length;
  countEl.textContent = n;
  if (!n) { avgEl.textContent = '—'; bestEl.textContent = '—'; p95El.textContent = '—'; return; }
  const sum = times.reduce((a, b) => a + b, 0);
  avgEl.textContent = (sum / n).toFixed(2) + 's';
  bestEl.textContent = Math.min(...times).toFixed(2) + 's';
  const sorted = [...times].sort((a, b) => a - b);
  const idx = Math.max(0, Math.min(n - 1, Math.ceil(0.95 * n) - 1));
  p95El.textContent = sorted[idx].toFixed(2) + 's';
}
</script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./service-worker.js').catch(() => {});
    });
  }
</script>
</body>
</html>
